{% extends "variants/dev/Dockerfile.base.sh.twig" %}

{% block shuwei %}
COPY ./assets/shuwei6/DockerSamplePlugin /var/www/html/plugins/DockerSamplePlugin

RUN sudo service mysql start && \
    # -------------------------------------------------------------------------------------------
    cd /var/www && \
    composer create-project 58shuwei/production --no-interaction tmp && \
    cp -a /var/www/tmp/. /var/www/html && \
    rm -rf /var/www/tmp && \
    # -------------------------------------------------------------------------------------------
    # ALWAYS UPDATE .env itself
    # if we would use .env.local, then these things could happen....our 127.0.0.1 instead of localhost for MySQL might not exist in a users custom .env.local
    # which would use Shuwei default with localhost, which breaks the DB connection in MySQL 8
    sed -i "/APP_ENV=/g" /var/www/html/.env && \
    sed -i "/APP_URL=/g" /var/www/html/.env && \
    sed -i "/DATABASE_URL=/g" /var/www/html/.env && \
    sed -i "/MAILER_URL=/g" /var/www/html/.env && \
    echo "APP_ENV=dev" >> /var/www/html/.env && \
    echo "APP_URL=http://localhost" >> /var/www/html/.env && \
    echo "DATABASE_URL=mysql://{{ db.user }}:{{ db.pwd }}@{{ db.host }}:{{ db.port }}/{{ db.database }}" >> /var/www/html/.env && \
    echo "MAILER_URL=smtp://127.0.0.1:1025" >> /var/www/html/.env && \
    # -------------------------------------------------------------------------------------------
    # install the correct Shuwei version
    cd /var/www/html && composer req 58shuwei/core:{{ sw_version }} 58shuwei/administration:{{ sw_version }} -W && \
    # -------------------------------------------------------------------------------------------
    # switch to default PHP before installing
    sudo update-alternatives --set php /usr/bin/php{{ php_version }} > /dev/null 2>&1 && \
    # -------------------------------------------------------------------------------------------
    cd /var/www/html && php bin/console system:install --create-database --basic-setup && \
    # make sure assets like logos are ready
    cd /var/www/html && php bin/console assets:install && \
    cd /var/www/html && composer require fakerphp/faker && \
    cd /var/www/html && composer require mbezhanov/faker-provider-collection && \
    cd /var/www/html && composer require maltyxx/images-generator && \
    # -------------------------------------------------------------------------------------------
   
    # -------------------------------------------------------------------------------------------
    cd /var/www/html && php bin/console plugin:install DockerSamplePlugin && \
    cd /var/www/html && php bin/console plugin:activate DockerSamplePlugin && \
    # -------------------------------------------------------------------------------------------
    # clear cache and refresh dal index to show the new demo data
    cd /var/www/html && php bin/console cache:clear && \
    cd /var/www/html && php bin/console dal:refresh:index && \
    rm -rf /var/www/html/var/cache/* && \
    # -------------------------------------------------------------------------------------------
    mysql --user={{ db.user }} --password={{ db.pwd }} -e "use {{ db.database }}; INSERT INTO system_config (id, configuration_key, configuration_value, sales_channel_id, created_at, updated_at) VALUES (X'b3ae4d7111114377af9480c4a0911111', 'core.frw.completedAt', '{\"_value\": \"2019-10-07T10:46:23+00:00\"}', NULL, '2019-10-07 10:46:23.169', NULL);" && \
    # -------------------------------------------------------------------------------------------
    sudo service mysql stop
{% endblock %}


